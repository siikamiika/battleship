<!DOCTYPE html>
<html>
<head>
    <title>Battleships</title>
    <style type="text/css">
    td {
        border: 1px solid black;
    }
    .square {
        box-sizing:border-box;
        -moz-box-sizing:border-box;
        -webkit-box-sizing:border-box;
        font-size: 20px;
        text-align: center;
        background-color: blue;
        height: 30px;
        width: 30px;
        color: transparent;
    }
    .ship {
        font-weight: bold;
        background-color: gray;
        color: black;
    }
    .hit {
        background-color: red;
        color: yellow;
    }
    #self {
        float: left;
    }
    #enemy {
        float: right;
    }
    </style>
</head>
<body>
<div id="self">
    <h2>Your fleet</h2>
    <table id="self.fleet">
    </table>
    <p id="self.turn"></p>
    <p id="self.ships_left"></p>
    <p id="self.ships_alive"></p>
</div>
<div id="enemy">
    <h2>Enemy fleet</h2>
    <table id="enemy.fleet">
    </table>
</div>
<script type="text/javascript">
function xhr (type, path, data, onready) {
    if (!onready) {
        onready = function(){};
    }
    var req = new XMLHttpRequest();
    req.onreadystatechange = function () {
        if (req.readyState == 4 && req.status == 200) {
            onready(req.responseText);
        }
    }
    req.open(type, path, true);
    req.send(data);
}

function activate_button(button, x, y) {
    button.onclick = function (e) {
        hit(x, y);
    }
}

function generate_fleet_table (id, enemy) {
    var el = document.getElementById(id);
    el.innerHTML = '';
    for (var y = 0; y < 10; y++) {
        var tr = document.createElement('tr');
        for (var x = 0; x < 10; x++) {
            var td = document.createElement('td');
            if (enemy) {
                activate_button(td, x, y);
            }
            tr.appendChild(td);
        }
        el.appendChild(tr);
    }
}

function update_fleet_table(id, json) {
    var el = document.getElementById(id);
    for (var y = 0, tr; tr = el.rows[y]; y++) {
        for (var x = 0, td; td = tr.cells[x]; x++) {
            var square = json[y][x];
            td.innerHTML = square.txt;
            td.className = square.cls.join(' ');
        }
    }
}

function update_game() {
    xhr('GET', '/gamestatus?' + window.token, null, function (gamestate_json) {
        gamestate_json = JSON.parse(gamestate_json);
        var own_fleet = gamestate_json.own;
        var enemy_fleet = gamestate_json.enemy;
        update_fleet_table('self.fleet', own_fleet);
        update_fleet_table('enemy.fleet', enemy_fleet);;
        var own_turn_element = document.getElementById('self.turn');
        if (gamestate_json.turn) {
            own_turn_element.innerHTML = 'It\'s your turn!';
        }
        else {
            own_turn_element.innerHTML = '';
        }
        var ships_alive_element = document.getElementById('self.ships_alive');
        ships_alive_element.innerHTML = JSON.stringify(gamestate_json.ships_alive);
        var ships_left_element = document.getElementById('self.ships_left');
        ships_left_element.innerHTML = JSON.stringify(gamestate_json.ships_left);
    });
}

function add_ship(coord, size, horizontal) {
    if (horizontal != true) horizontal = false;
    var postdata = JSON.stringify({'coord': coord,'size': size,'horizontal': horizontal});
    xhr('POST', '/addship?' + window.token, postdata, function (asdf) {
        update_game();
    });
}

function generate_ships () {
    add_ship([0, 0], 1);
    add_ship([1, 0], 2);
    add_ship([2, 0], 3);
    add_ship([3, 0], 3);
    add_ship([4, 0], 4);
    add_ship([5, 0], 5);
}

function hit(x, y) {
    var postdata = JSON.stringify({'x': x, 'y': y});
    xhr('POST', '/hit?' + window.token, postdata, function (asdf) {
        update_game();
    });
}

window.addEventListener("load", function () {
    xhr('GET', '/start', null, function (token_json) {
        window.token = JSON.parse(token_json);
        generate_fleet_table('self.fleet');
        generate_fleet_table('enemy.fleet', true);
        generate_ships();
        window.setInterval(function () {update_game()}, 1000);
    });
}, false);
</script>
</body>
</html>
