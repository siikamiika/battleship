<!DOCTYPE html>
<html>
<head>
    <title>Battleship</title>
    <style type="text/css">
    .square {
        box-sizing:border-box;
        -moz-box-sizing:border-box;
        -webkit-box-sizing:border-box;
        font-size: 20px;
        text-align: center;
        background-color: blue;
        height: 30px;
        width: 30px;
        color: transparent;
    }
    .ship {
        font-weight: bold;
        background-color: gray;
        color: black;
    }
    .hit {
        background-color: red;
        color: yellow;
    }
    #self {
        float: left;
    }
    #enemy {
        float: right;
    }
    .hide {
        color: transparent;
    }
    </style>
</head>
<body>
<div id="self">
    <h2>Your fleet</h2>
    <table id="self.fleet">
    </table>
    <p class="hide" id="self.turn">It's your turn</p>
    <table>
        <tr>
            <th>Ships left to place</th>
            <th>Ships alive</th>
        </tr>
        <tr>
            <td id="self.ships_left"></td>
            <td id="self.ships_alive"></td>
        </tr>
    </table>
</div>
<div id="enemy">
    <h2>Enemy fleet</h2>
    <table id="enemy.fleet">
    </table>
    <p class="hide" id="enemy.turn">It's enemy turn</p>
    <table>
        <tr>
            <th>Ships left to place</th>
            <th>Ships alive</th>
        </tr>
        <tr>
            <td id="enemy.ships_left"></td>
            <td id="enemy.ships_alive"></td>
        </tr>
    </table>
</div>
<script type="text/javascript">
function xhr (type, path, data, onready) {
    if (!onready) {
        onready = function(){};
    }
    var req = new XMLHttpRequest();
    req.onreadystatechange = function () {
        if (req.readyState == 4 && req.status == 200) {
            onready(req.responseText);
        }
    }
    req.open(type, path, true);
    req.send(data);
}

function activate_button(button, x, y) {
    button.onclick = function (e) {
        hit(x, y);
    }
}

function generate_fleet_table (id, enemy) {
    var el = document.getElementById(id);
    el.innerHTML = '';
    for (var y = 0; y < 10; y++) {
        var tr = document.createElement('tr');
        for (var x = 0; x < 10; x++) {
            var td = document.createElement('td');
            if (enemy) {
                activate_button(td, x, y);
            }
            tr.appendChild(td);
        }
        el.appendChild(tr);
    }
}

function update_fleet_table(player, json) {
    var el = document.getElementById(player + '.fleet');
    for (var y = 0, tr; tr = el.rows[y]; y++) {
        for (var x = 0, td; td = tr.cells[x]; x++) {
            var square = json[y][x];
            td.innerHTML = square.txt;
            td.className = square.cls.join(' ');
        }
    }
}

function repeat_string(str, times) {
    return Array(times + 1).join(str);
}

function ships_left_as_html(json) {
    var output = '';
    return output;
}

function ships_alive_as_html(json) {
    var output = '';
    for (var i = 0; i < json.length; i++) {
        output += '<br>';
        var ship = json[i];
        if (ship.lives) {
            output += repeat_string('O', ship.lives) + repeat_string('X', ship.size - ship.lives);
        }
        else {
            output += repeat_string('O', ship.size);
        }
    }
    return output.slice(4);
}

function update_game_status(player, json) {
    var turn_el = document.getElementById(player + '.turn');
    var ships_left_el = document.getElementById(player + '.ships_left');
    var ships_alive_el = document.getElementById(player + '.ships_alive');
    if (!json.turn) {
        turn_el.className = 'hide';
    }
    else {
        turn_el.className = '';
    }
    ships_left_el.innerHTML = ships_left_as_html(json.ships_left);
    ships_alive_el.innerHTML = ships_alive_as_html(json.ships_alive);
    if (json.winner) {
        window.clearInterval(window.updater_id);
        if (player == 'self') {
            alert('olet viineri');
        }
        else if (player == 'enemy') {
            alert('olet luuseri');
        }
    }
}

function update_game() {
    xhr('GET', '/gamestatus?' + window.token, null, function (gamestate_json) {
        gamestate_json = JSON.parse(gamestate_json);
        update_fleet_table('self', gamestate_json.own.squares);
        update_fleet_table('enemy', gamestate_json.enemy.squares);
        update_game_status('self', gamestate_json.own);
        update_game_status('enemy', gamestate_json.enemy);
    });
}

function add_ship(coord, size, horizontal) {
    if (horizontal != true) horizontal = false;
    var postdata = JSON.stringify({'coord': coord,'size': size,'horizontal': horizontal});
    xhr('POST', '/addship?' + window.token, postdata, function (asdf) {
        update_game();
    });
}

function generate_ships () {
    add_ship([0, 0], 1);
    add_ship([1, 0], 2);
    add_ship([2, 0], 3);
    add_ship([3, 0], 3);
    add_ship([4, 0], 4);
    add_ship([5, 0], 5);
}

function hit(x, y) {
    var postdata = JSON.stringify({'x': x, 'y': y});
    xhr('POST', '/hit?' + window.token, postdata, function (asdf) {
        update_game();
    });
}

window.addEventListener("load", function () {
    xhr('GET', '/start', null, function (token_json) {
        window.token = JSON.parse(token_json);
        generate_fleet_table('self.fleet');
        generate_fleet_table('enemy.fleet', true);
        generate_ships();
        window.updater_id = window.setInterval(function () {
            update_game();
        }, 1000);
    });
}, false);
</script>
</body>
</html>
